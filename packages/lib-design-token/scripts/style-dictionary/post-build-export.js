import fs from 'node:fs'
import { cp, mkdir } from 'node:fs/promises'
import { dirname, resolve } from 'node:path'
import { fileURLToPath, pathToFileURL } from 'node:url'

import { extractTokenValue } from './process-tokens.js'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const packageRoot = resolve(__dirname, '..', '..')
const distRoot = resolve(packageRoot, 'dist')
const generatedDir = resolve(packageRoot, 'src/generated')
const fontsSourceDir = resolve(packageRoot, 'assets/fonts')
const fontsDistDir = resolve(distRoot, 'font') // Changed to dist/font/

const lightTokensModule = await import(
  pathToFileURL(resolve(distRoot, 'jsts/light/variables.js')).href
)
const darkTokensModule = await import(
  pathToFileURL(resolve(distRoot, 'jsts/dark/variables.js')).href
)

const lightTokens = extractTokenValue(asRecord(lightTokensModule.default))
const darkTokens = extractTokenValue(asRecord(darkTokensModule.default))

// Wrap in namespace structure
const light = {
  dg: lightTokens
}

const dark = {
  dg: darkTokens
}

await mkdir(generatedDir, { recursive: true })

const themesModulePath = resolve(generatedDir, 'themes.ts')

const fileHeader = `// Auto-generated by style dictionary post-build script.\n// Do not edit directly.\n`

const themesSource = `${fileHeader}
export const light = ${JSON.stringify(light, null, 2)} as const

export const dark = ${JSON.stringify(dark, null, 2)} as const

export const themes = { light, dark } as const

export type ThemeName = keyof typeof themes
`

fs.writeFileSync(themesModulePath, themesSource)

// Copy fonts to dist/font/ directory (alongside font-face.css generated by Style Dictionary)
if (fs.existsSync(fontsSourceDir)) {
  // Don't delete the entire directory - font-face.css is already there from Style Dictionary
  // Just copy the font files into it
  await cp(fontsSourceDir, fontsDistDir, { recursive: true })
  console.log('âœ“ Fonts copied to dist/font/')
}

/**
 * @param {unknown} value
 * @returns {Record<string, unknown>}
 */
function asRecord(value) {
  if (value && typeof value === 'object') {
    return /** @type {Record<string, unknown>} */ (value)
  }

  return {}
}
