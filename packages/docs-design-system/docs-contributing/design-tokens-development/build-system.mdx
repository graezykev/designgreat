---
sidebar_position: 4
description: Style Dictionary configuration and pipeline
---

# Build System

This guide explains the Style Dictionary build pipeline and configuration for the design tokens package.

## Pipeline Overview

The build pipeline consists of three sequential scripts:

1. **`prebuild-download-fonts.js`** – Downloads Roboto font files from Google Fonts CDN
2. **`build-style-dictionary.js`** – Runs Style Dictionary for each theme (light, dark)
3. **`post-build-export.js`** – Generates `src/generated/themes.ts` with combined token payloads

## Build Scripts

### Available Scripts

| Script                  | Description                                                                                                                                                                                                    |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `pnpm run build`        | Clean previously generated artifacts, rebuild tokens (fonts download → Style Dictionary multi-platform build → TypeScript generation), compile the runtime, and copy the raw token sources into `dist/tokens`. |
| `pnpm run build:tokens` | Run only the token toolchain (best-effort Roboto font fetch, Style Dictionary build, `src/generated/themes.ts` emission).                                                                                      |
| `pnpm run watch`        | Convenience alias for `pnpm run build:tokens`. Useful while iterating on token files.                                                                                                                          |
| `pnpm run validate`     | Execute integrity checks for the generated themes (ensures required sections exist).                                                                                                                           |
| `pnpm run test`         | Run the Vitest suite for the runtime helpers and validation utilities.                                                                                                                                         |
| `pnpm run lint`         | Lint the TypeScript runtime and build scripts.                                                                                                                                                                 |
| `pnpm run typecheck`    | Type-check the runtime source without emitting files.                                                                                                                                                          |

### Full Build Command

```bash
pnpm --filter @designgreat/lib-web-ui-design-token run build
```

This runs the complete pipeline:

1. Clean (`rm -rf dist src/generated`)
2. Build tokens (download fonts → Style Dictionary → generate themes.ts)
3. Compile TypeScript runtime
4. Copy token sources to dist

## Style Dictionary Configuration

### Configuration Entry Point

The main configuration is in `scripts/style-dictionary/config.js`. It extends Style Dictionary v5 with custom transforms and formats.

### Module Loading

`scripts/style-dictionary/load-style-dictionary.js` resolves the local Style Dictionary dependency before executing the custom config.

### Custom Transforms

Key custom transforms registered in `config.js`:

#### Line Height Transform

```javascript
// Converts font sizes to relative line heights
{
  name: 'line-height',
  type: 'value',
  transitive: true
}
```

#### Color Theme Mapping

```javascript
// Applies theme-specific color transformations
{
  name: 'colorShadesMapping:light',
  name: 'colorShadesMapping:dark'
}
```

#### Shadow Shorthand

```javascript
// Converts shadow objects to CSS shorthand
{
  name: 'text-shadow/css/shorthand',
  type: 'value'
}
```

#### Gradient Shorthands

```javascript
// Gradient shorthands for CSS
{
  name: 'linear-gradient/shorthand',
  name: 'radial-gradient/shorthand',
  name: 'conic-gradient/shorthand'
}
```

#### Composition Flattening

```javascript
// Flattens nested composition tokens
{
  name: 'css/flatten-composition-properties',
  type: 'value'
}
```

## Theme Generation

### Multi-Theme Build

The build targets `light` and `dark` themes sequentially to:

- Keep output ordering deterministic
- Surface naming collisions via Style Dictionary warnings
- Ensure both themes have the same token structure

### Theme-Specific Output

Each theme generates:

```
dist/
├── css/
│   ├── light/
│   │   ├── variables.css
│   │   └── variables.scss
│   └── dark/
│       ├── variables.css
│       └── variables.scss
├── jsts/
│   ├── light/
│   │   ├── variables.js
│   │   └── variables.d.ts
│   └── dark/
│       ├── variables.js
│       └── variables.d.ts
```

## Font Asset Management

### Font Download

The `prebuild-download-fonts.js` script:

- Fetches Roboto font files from Google Fonts CDN
- Downloads all weights and variants
- Saves to `assets/fonts/` directory
- Gracefully fails if offline (with warnings)

### Font Optimization

- Font-face definitions are generated once in `dist/font/font-face.css`
- Font files use relative paths (`./filename.woff2`)
- Entire `dist/font/` directory is self-contained
- Theme-independent (shared across all themes)

### Font Output

```
dist/font/
├── font-face.css
├── Roboto-Thin.woff2
├── Roboto-Light.woff2
├── Roboto-Regular.woff2
├── Roboto-Medium.woff2
├── Roboto-Bold.woff2
└── ... (108 font files total)
```

## Generated Runtime

### themes.ts Generation

The `post-build-export.js` script generates `src/generated/themes.ts`:

```typescript
// Auto-generated file
export const themes = {
  light: { /* flattened token object */ },
  dark: { /* flattened token object */ }
}
```

This file powers the TypeScript runtime with helpers like:

- `getThemeTokens(themeName)`
- `createTheme(baseTheme, overrides)`
- `listThemeNames()`

### Runtime Compilation

After token generation, TypeScript compiles:

```
src/index.ts → dist/index.js + dist/index.d.ts
```

## When to Regenerate

Run `pnpm run build` whenever:

- Files under `src/tokens/**` change
- Font configurations are updated
- Style Dictionary config is modified
- Custom transforms are added or changed

## Build Performance

### Optimization Tips

- Use `pnpm run watch` for quick iteration
- Run full `pnpm run build` before committing
- Font download is cached in `assets/fonts/`
- Style Dictionary build is fast (< 1 second)

### CI/CD Considerations

- Run full build in CI to ensure consistency
- Commit generated files to track changes
- Validate token integrity after build

## Debugging Build Issues

### Enable Verbose Logging

```bash
DEBUG=style-dictionary:* pnpm run build:tokens
```

### Check Generated Files

After build, verify:

- `dist/css/light/variables.css` exists
- `dist/jsts/light/variables.js` exists
- `src/generated/themes.ts` is valid TypeScript
- `dist/font/font-face.css` references correct fonts

### Common Build Errors

See [Troubleshooting](./troubleshooting) for solutions to common issues.

## Next Steps

- Learn about the [Development Workflow](./development-workflow)
- Review [Testing & Validation](./testing-validation)
- Understand [Token Authoring](./token-authoring)

