---
sidebar_position: 7
description: Quality gates and testing strategies
---

# Testing & Validation

This guide covers testing strategies, validation tools, and quality assurance for the design tokens package.

## Testing Overview

The design tokens package uses multiple layers of testing:

1. **Unit Tests** – Runtime helpers and utilities
2. **Integration Tests** – Downstream package compatibility
3. **Validation Scripts** – Token structure integrity
4. **Type Checking** – TypeScript compilation

## Unit Testing

### Running Tests

```bash
# Run all tests
pnpm run test

# Run in watch mode
pnpm run test -- --watch

# Run with coverage
pnpm run test -- --coverage
```

### Test Framework

The package uses [Vitest](https://vitest.dev/) for unit testing:

```typescript
// src/__tests__/runtime.test.ts
import { describe, expect, it } from 'vitest'
import { getThemeTokens, listThemeNames, createTheme } from '../index'

describe('getThemeTokens', () => {
  it('should return light theme tokens', () => {
    const tokens = getThemeTokens('light')
    expect(tokens).toBeDefined()
    expect(tokens.color).toBeDefined()
  })

  it('should return dark theme tokens', () => {
    const tokens = getThemeTokens('dark')
    expect(tokens).toBeDefined()
    expect(tokens.color).toBeDefined()
  })
})
```

### Test Coverage

Key areas covered by tests:

- **Runtime Helpers** – `getThemeTokens`, `createTheme`, `listThemeNames`
- **Token Integrity** – Validation utilities
- **Theme Cloning** – Deep copy and merge logic
- **Type Safety** – TypeScript definitions

## Token Validation

### Running Validation

```bash
pnpm run validate
```

This executes `src/run-validation.ts` which:

- Ensures all required token sections exist in each theme
- Validates token structure matches expected schema
- Checks for missing or malformed tokens

### Validation Script

```typescript
// src/run-validation.ts
import { validateThemes } from './validation'
import { themes } from './generated/themes'

const result = validateThemes(themes)

if (!result.valid) {
  console.error('Token validation failed:')
  result.errors.forEach(error => console.error(`  - ${error}`))
  process.exit(1)
}

console.log('✓ All tokens validated successfully')
```

### Custom Validation Rules

Add custom rules in `src/validation.ts`:

```typescript
// src/validation.ts
export function validateThemes(themes: Record<string, any>) {
  const errors: string[] = []
  
  // Check required sections
  const requiredSections = ['color', 'typography', 'size', 'shadow']
  
  for (const [themeName, theme] of Object.entries(themes)) {
    for (const section of requiredSections) {
      if (!theme[section]) {
        errors.push(`Missing section "${section}" in theme "${themeName}"`)
      }
    }
  }
  
  return {
    valid: errors.length === 0,
    errors
  }
}
```

## Type Checking

### Running Type Check

```bash
pnpm run typecheck
```

This runs TypeScript compiler without emitting files:

```json
// tsconfig.json
{
  "compilerOptions": {
    "noEmit": true,
    "strict": true,
    "skipLibCheck": false
  }
}
```

### Type Safety Benefits

- Catches errors early in development
- Ensures runtime matches type definitions
- Validates generated `themes.ts` structure
- Verifies custom transforms don't break types

## Integration Testing

### Testing Downstream Packages

After token changes, test dependent packages:

```bash
# Test design token package
pnpm --filter @designgreat/lib-design-token build

# Test component library
pnpm --filter @designgreat/lib-web-ui build
pnpm --filter @designgreat/lib-web-ui test

# Test documentation site
pnpm --filter @designgreat/docs-design-system build
```

### CSS Variable Integration

Test that CSS variables are correctly generated:

```bash
# Check generated CSS files
cat packages/lib-design-token/dist/css/light/variables.css
cat packages/lib-design-token/dist/css/dark/variables.css

# Check TypeScript exports
cat packages/lib-design-token/src/generated/themes.ts
```

### Visual Regression Testing

Use Storybook to verify visual changes:

```bash
# Build tokens and component library
pnpm --filter @designgreat/lib-design-token build
pnpm --filter @designgreat/lib-web-ui build

# Start Storybook
pnpm --filter @designgreat/lib-web-ui run storybook
```

Compare component renders before and after token changes.

## Continuous Integration

### CI Pipeline

The monorepo CI runs these checks:

1. Install dependencies (`pnpm install`)
2. Build all packages (`pnpm run build`)
3. Run linting (`pnpm run lint`)
4. Run tests (`pnpm run test`)
5. Run validation (`pnpm run validate`)
6. Type check (`pnpm run typecheck`)

### Pre-commit Hooks

Set up git hooks to run checks before committing:

```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

pnpm --filter @designgreat/lib-design-token run lint
pnpm --filter @designgreat/lib-design-token run test
pnpm --filter @designgreat/lib-design-token run validate
```

## Quality Gates

### Before Committing

Ensure all checks pass:

```bash
pnpm run lint && \
pnpm run test && \
pnpm run typecheck && \
pnpm run validate
```

### Before Publishing

Additional checks before publishing:

```bash
# Full build
pnpm run build

# Verify exports
node -e "console.log(require('./dist/index.js'))"

# Check package size
npm pack --dry-run

# Test in example app
pnpm --filter example-app build
```

## Common Test Scenarios

### Test Theme Switching

```typescript
import { getThemeTokens } from '../index'

describe('theme switching', () => {
  it('should have different colors for light and dark themes', () => {
    const light = getThemeTokens('light')
    const dark = getThemeTokens('dark')
    
    expect(light.color.background.primary)
      .not.toBe(dark.color.background.primary)
  })
})
```

### Test Token References

```typescript
describe('token references', () => {
  it('should resolve color references correctly', () => {
    const tokens = getThemeTokens('light')
    
    // Verify references are resolved
    expect(tokens.color.background.primary).toMatch(/^#[0-9A-F]{6}$/i)
  })
})
```

### Test Custom Transforms

```typescript
describe('alpha transform', () => {
  it('should apply alpha transparency', () => {
    const tokens = getThemeTokens('light')
    
    // Check that alpha is applied
    expect(tokens.color.primary.translucent).toContain('rgba')
  })
})
```

## Debugging Test Failures

### View Test Output

```bash
# Run tests with verbose output
pnpm run test -- --reporter=verbose
```

### Debug Specific Test

```bash
# Run single test file
pnpm run test src/__tests__/runtime.test.ts

# Run specific test case
pnpm run test -- -t "should return light theme tokens"
```

### Inspect Generated Files

When tests fail, check generated files:

```bash
# View generated themes
cat src/generated/themes.ts

# View CSS output
cat dist/css/light/variables.css

# View JS output
cat dist/jsts/light/variables.js
```

## Performance Testing

### Build Performance

```bash
# Time the build
time pnpm run build:tokens
```

### Bundle Size Analysis

```bash
# Check dist size
du -sh dist/

# Check individual outputs
ls -lh dist/css/light/
ls -lh dist/font/
```

## Next Steps

- Review [Troubleshooting](./troubleshooting) for common issues
- Learn about the [Development Workflow](./development-workflow)
- Understand the [Build System](./build-system)

