# ⚠️ DEPRECATED: This workflow has been replaced by deploy-docs-storybook-gh-pages.yml
# The unified workflow prevents race conditions and ensures atomic deployments
# This file is kept for reference but should not be triggered
name: Deploy docs-design-system Docusaurus (DEPRECATED)

# Trigger disabled - now handled by deploy-docs-storybook-gh-pages.yml
# on:
#   workflow_run:
#     workflows:
#       - Version and Publish Packages
#     types:
#       - completed

on:
  workflow_dispatch: # Manual trigger only for emergency use

concurrency:
  group: github-pages-deployment
  cancel-in-progress: false

jobs:
  build-and-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    env:
      PNPM_CACHE_FOLDER: .pnpm-store
    steps:
      - name: Checkout repository at triggering commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Detect docs-design-system related changes
        id: doc_changes
        run: |
          set -eo pipefail
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            base_ref=HEAD^
          else
            base_ref=$(git rev-list --max-parents=0 HEAD)
          fi
          if git diff --name-only "$base_ref" HEAD | grep -E '^packages/docs-design-system/|^packages/lib-web-ui/|^packages/lib-design-token/|^\.github/workflows/deploy-docs-design-system\.yml$'; then
            echo "doc_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "doc_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup pnpm
        if: steps.doc_changes.outputs.doc_changed == 'true'
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        if: steps.doc_changes.outputs.doc_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: pnpm

      - name: Install dependencies
        if: steps.doc_changes.outputs.doc_changed == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build dependencies
        if: steps.doc_changes.outputs.doc_changed == 'true'
        run: |
          pnpm --filter @designgreat/lib-design-token run build

      - name: Build component library (dependency for docs CSS)
        if: steps.doc_changes.outputs.doc_changed == 'true'
        run: pnpm --filter @designgreat/lib-web-ui build

      - name: Build Docusaurus site
        if: steps.doc_changes.outputs.doc_changed == 'true'
        run: pnpm --filter @designgreat/docs-design-system build

      - name: Upload Pages artifact
        if: steps.doc_changes.outputs.doc_changed == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: packages/docs-design-system/build

      - name: Deploy to GitHub Pages
        if: steps.doc_changes.outputs.doc_changed == 'true'
        uses: actions/deploy-pages@v4

      - name: Skip deployment (no relevant changes)
        if: steps.doc_changes.outputs.doc_changed != 'true'
        run: echo "No documentation changes detected, skipping deployment."
