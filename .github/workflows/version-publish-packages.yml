name: Version and Publish Packages

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_publish_only:
        description: 'Skip versioning steps and trigger publish job only'
        required: false
        type: boolean
        default: false

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      versioned: ${{ steps.commit-version.outputs.versioned || steps.publish-only.outputs.versioned }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set publish-only output
        id: publish-only
        if: github.event_name == 'workflow_dispatch' && inputs.run_publish_only == true
        run: echo "versioned=true" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'
        if: github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 9
        if: github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true

      - name: Cache PNPM store
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-
        if: github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true

      - name: Install dependencies
        if: github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true
        run: pnpm install

      - name: Inject metadata into changeset files
        id: inject-metadata
        continue-on-error: true
        if: github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true
        run: pnpm exec tsx scripts/inject-changeset-metadata.ts
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Version (bumps versions, updates changelogs, deletes .changeset/*.md)
        if: (github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true) && steps.inject-metadata.outcome == 'success'
        run: pnpm exec changeset version

      - name: Commit (version bump and changelog updates)
        id: commit-version
        if: (github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true) && steps.inject-metadata.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          if git diff --cached --quiet; then
            echo "versioned=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore: version packages and update changelogs"
            git push origin main --no-verify
            echo "versioned=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip due to metadata injection failure
        if: (github.event_name != 'workflow_dispatch' || inputs.run_publish_only != true) && steps.inject-metadata.outcome != 'success'
        run: echo "Metadata injection failed; skipping versioning steps."

  publish:
    needs: version
    if: needs.version.outputs.versioned == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest pushed commit
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Cache PNPM store
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install

      - name: Build dependent packages
        run: |
          pnpm --filter @designgreat/lib-design-token run build
          pnpm --filter @designgreat/lib-web-component run build

      - name: Publish packages
        run: pnpm exec changeset publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
